<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ESP32 Accident Dashboard (MQTT)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="relative min-h-screen bg-slate-900 text-slate-900">
    <div id="map" class="fixed inset-0 z-0"></div>
    <div class="pointer-events-none relative z-10 min-h-screen">
        <div id="top" class="pointer-events-auto sticky top-0 border-b border-slate-200 bg-white/90 backdrop-blur">
            <div class="mx-auto flex max-w-6xl flex-wrap items-center gap-3 px-4 py-3">
            <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-900 text-white shadow-sm">
                    <span class="text-lg font-semibold">RX</span>
                </div>
                <div>
                    <div class="text-sm font-semibold uppercase tracking-widest text-slate-500">ESP32 Accident Dashboard</div>
                    <div class="text-xs text-slate-500">Live MQTT telemetry</div>
                </div>
            </div>
            <div class="ml-auto flex flex-wrap items-center gap-2">
                <div class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600" id="status">Disconnected</div>
                <div class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs text-slate-600">GPS: <b id="gpsTopic" class="font-semibold text-slate-900"></b></div>
                <div class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs text-slate-600">Event: <b id="evtTopic" class="font-semibold text-slate-900"></b></div>
            </div>
            </div>
        </div>
        <main class="pointer-events-auto absolute left-6 top-28 z-10 flex w-[320px] flex-col gap-4">
            <div class="flex flex-col gap-4">
                <aside class="flex w-full flex-col gap-4">
                <section class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-sm backdrop-blur">
                    <div class="text-sm font-semibold text-slate-700">Connection</div>
                    <div class="mt-3 space-y-2 text-xs text-slate-600">
                        <div class="flex items-center justify-between">
                            <span>Status</span>
                            <span id="statusBadge" class="rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-[11px] font-semibold text-slate-500">Disconnected</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Broker</span>
                            <span id="brokerUrl" class="text-[11px] font-semibold text-slate-700"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Device</span>
                            <span class="text-[11px] font-semibold text-slate-700" id="deviceId"></span>
                        </div>
                    </div>
                </section>
                <section class="rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-sm backdrop-blur">
                    <div class="text-sm font-semibold text-slate-700">Latest Event</div>
                    <div id="latestEvent" class="mt-3 rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-4 text-xs text-slate-500">
                        Waiting for accident payload...
                    </div>
                </section>
            </aside>
        </div>
        <section class="overflow-hidden rounded-2xl border border-slate-200 bg-white/90 shadow-sm backdrop-blur">
            <div class="flex items-center justify-between border-b border-slate-200 px-4 py-2">
                <div class="text-sm font-semibold text-slate-700">Activity Log</div>
                <div class="text-xs text-slate-400">Recent MQTT messages</div>
            </div>
            <div id="log" class="h-28 overflow-auto px-4 py-3 text-xs text-slate-600"></div>
        </section>
        </main>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const DEVICE_ID = "esp32-01";
        const GPS_TOPIC = `accident/${DEVICE_ID}/gps`;
        const EVT_TOPIC = `accident/${DEVICE_ID}/event`;

        document.getElementById("gpsTopic").textContent = GPS_TOPIC;
        document.getElementById("evtTopic").textContent = EVT_TOPIC;

        const statusEl = document.getElementById("status");
        const statusBadgeEl = document.getElementById("statusBadge");
        const brokerUrlEl = document.getElementById("brokerUrl");
        const deviceIdEl = document.getElementById("deviceId");
        const latestEventEl = document.getElementById("latestEvent");
        const logEl = document.getElementById("log");

        function log(msg) {
            const line = document.createElement("div");
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        const map = L.map('map').setView([-6.7924, 39.2083], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let marker = L.marker([-6.7924, 39.2083]).addTo(map).bindPopup("Device: " + DEVICE_ID);
        let accidentMarker = null;

        // Use WSS when served over HTTPS to avoid mixed-content blocks.
        const WS_URL = (location.protocol === "https:")
            ? "wss://test.mosquitto.org:8081"
            : "ws://test.mosquitto.org:8080";
        brokerUrlEl.textContent = WS_URL;
        deviceIdEl.textContent = DEVICE_ID;

        const client = mqtt.connect(WS_URL, {
            clientId: "webdash-" + DEVICE_ID + "-" + Math.random().toString(16).slice(2),
            keepalive: 30,
            reconnectPeriod: 1500
        });

        client.on("connect", () => {
            statusEl.textContent = "Connected";
            statusEl.className = "rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700";
            statusBadgeEl.textContent = "Connected";
            statusBadgeEl.className = "rounded-full border border-emerald-200 bg-emerald-50 px-2 py-1 text-[11px] font-semibold text-emerald-700";
            log("MQTT connected");
            client.subscribe([GPS_TOPIC, EVT_TOPIC]);
        });

        client.on("reconnect", () => log("MQTT reconnecting..."));
        client.on("close", () => {
            statusEl.textContent = "Disconnected";
            statusEl.className = "rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700";
            statusBadgeEl.textContent = "Disconnected";
            statusBadgeEl.className = "rounded-full border border-rose-200 bg-rose-50 px-2 py-1 text-[11px] font-semibold text-rose-700";
        });
        client.on("error", (err) => log("MQTT error: " + err.message));

        client.on("message", (topic, payload) => {
            let data;
            try { data = JSON.parse(payload.toString()); }
            catch { return; }

            if (topic === GPS_TOPIC) {
                const { lat, lon } = data;
                marker.setLatLng([lat, lon]);
                marker.setPopupContent(`Device: ${DEVICE_ID}<br>Lat: ${lat}<br>Lon: ${lon}`);
                map.panTo([lat, lon], { animate: true });
            }

            if (topic === EVT_TOPIC) {
                log("ACCIDENT event: " + payload.toString());
                const { lat, lon, acc_ms2 } = data;
                latestEventEl.innerHTML = `<div class="text-[11px] font-semibold text-rose-600">ACCIDENT DETECTED</div>
                    <div class="mt-2 grid gap-1 text-[11px] text-slate-600">
                        <div>Acceleration: <span class="font-semibold text-slate-800">${acc_ms2} m/s²</span></div>
                        <div>Latitude: <span class="font-semibold text-slate-800">${lat}</span></div>
                        <div>Longitude: <span class="font-semibold text-slate-800">${lon}</span></div>
                    </div>`;

                if (accidentMarker) map.removeLayer(accidentMarker);
                accidentMarker = L.circleMarker([lat, lon], { radius: 10 }).addTo(map)
                    .bindPopup(`ACCIDENT<br>acc: ${acc_ms2} m/s²<br>${lat}, ${lon}`)
                    .openPopup();
            }
        });
    </script>
</body>

</html>
